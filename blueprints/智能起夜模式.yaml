blueprint:
  name: æ™ºèƒ½èµ·å¤œæ¨¡å¼
  description: |
    å®ç°â€œå•é”®æ§åˆ¶çª—å¸˜å¾ªç¯ (å¼€ -> åœ -> å…³ -> åœ)â€ï¼Œå®Œç¾æ”¯æŒå¤šç§è®¾å¤‡æ··ç”¨ã€‚
    
    ### âœ¨ åŠŸèƒ½äº®ç‚¹
    1. **æ™ºèƒ½å¾ªç¯**ï¼šæŒ‰é”®è§¦å‘æ—¶ï¼Œæ ¹æ®çª—å¸˜å½“å‰çŠ¶æ€è‡ªåŠ¨å†³å®šæ˜¯åœæ­¢è¿˜æ˜¯åå‘åŠ¨ä½œã€‚
    2. **çŠ¶æ€è¿½è¸ª**ï¼šè‡ªåŠ¨ç›‘å¬ç³»ç»Ÿçš„å¼€/å…³æŒ‡ä»¤ï¼Œè®¡ç®—å‰©ä½™æ—¶é—´ï¼Œç¡®ä¿â€œæ­£åœ¨è¿è¡Œâ€çŠ¶æ€å‡†ç¡®ã€‚
    3. **ä¸‡èƒ½å…¼å®¹**ï¼šåŒæ—¶æ”¯æŒ **KNXé¢æ¿** (æ— å±æ€§)ã€**é¢†æ™®/ç±³å®¶** (Eventå±æ€§)ã€**å®œå®¶/Z2M** (çŠ¶æ€å€¼)ã€‚

    ---
    ### âš™ï¸ é…ç½®è¯´æ˜
    
    **1. æ·»åŠ è§¦å‘å™¨**
    åœ¨â€œæ‰€æœ‰æ§åˆ¶æŒ‰é’®è§¦å‘å™¨â€ä¸­æ·»åŠ æ‚¨çš„æ§åˆ¶è®¾å¤‡ã€‚
    
    **2. é…ç½®è¿‡æ»¤æ¨¡æ¿ (æŒ‰éœ€é…ç½®)**
    *   âœ… **KNX / æ™®é€šæŒ‰é”®**ï¼š**æ— éœ€é…ç½®**ï¼Œè¯·ç›´æ¥è·³è¿‡æ­¤æ­¥ï¼ˆä¿æŒé»˜è®¤å€¼ `{{ true }}` å³å¯ï¼‰ã€‚
    *   âš ï¸ **é¢†æ™® / å®œå®¶é¥æ§**ï¼šç”±äºæ­¤ç±»è®¾å¤‡ä¸€ä¸ªå®ä½“å¯¹åº”å¤šä¸ªæŒ‰é”®ï¼Œ**å¿…é¡»**å¤åˆ¶ä¸‹æ–¹ä»£ç åˆ°æ–‡æœ¬æ¡†ä¸­å¹¶ä¿®æ”¹ IDï¼Œä»¥ä¾¿è¯†åˆ«ç‰¹å®šæŒ‰é”®ã€‚
    
    ```jinja2
    {# ========== ç”¨æˆ·é…ç½®åŒºåŸŸ ========== #}
    {# 1. è¾“å…¥é¢†æ™®å’Œå®œå®¶é¥æ§å™¨çš„å®ä½“ ID #}
    {% set linp_id = 'event.dinnerroom_linp_remote_control_click' %}
    {% set ikea_id = 'sensor.ikea_remote_action' %}

    {# 2. è®¾ç½®å®œå®¶é¥æ§å™¨æŒ‰é”®ä»£ç : toggle, arrow_left_click ç­‰ #}
    {% set ikea_target_button = 'arrow_left_click' %}

    {# ========== é€»è¾‘æ‰§è¡ŒåŒºåŸŸ ========== #}
    {% if trigger.entity_id == linp_id %}
        {{ trigger.to_state.attributes.æŒ‰é”®ç±»å‹ == 1 }}
    {% elif trigger.entity_id == ikea_id %}
        {{ trigger.to_state.state == ikea_target_button }}
    {% else %}
        true
    {% endif %}
    ```

  domain: automation
  input:
    # ===========================
    # 1. æ ¸å¿ƒä¼ æ„Ÿå™¨
    # ===========================
    pressure_sensor:
      name: åºŠé“ºå‹åŠ›ä¼ æ„Ÿå™¨
      description: "Binary Sensor: on=åœ¨åºŠä¸Š, off=ç¦»åºŠ"
      selector:
        entity:
          domain: binary_sensor

    bedroom_status_light:
      name: "å§å®¤ç¯å…‰çŠ¶æ€æ£€æµ‹ (æ ¸å¿ƒ)"
      description: "âš ï¸ å¿…é¡»åŒ…å«å§å®¤æ‰€æœ‰ç¯çš„ç»„(Group)æˆ–ä¼ æ„Ÿå™¨ã€‚"
      selector:
        entity:
          domain: 
            - light
            - binary_sensor
            - group

    motion_sensor_bedside:
      name: "åºŠè¾¹/åœ°è„šä¼ æ„Ÿå™¨"
      description: "ç”¨äºæ£€æµ‹ä¸‹åºŠåŠ¨ä½œã€‚æ”¯æŒ Binary æˆ– Eventã€‚"
      selector:
        entity:
          domain:
            - binary_sensor
            - event

    motion_event_keyword:
      name: "Event è§¦å‘å…³é”®è¯"
      description: "ä»… Event å®ä½“éœ€è¦å¡«å†™ï¼Œå¦‚ 'æœ‰äººç§»åŠ¨'ã€‚Binary Sensor å¿½ç•¥æ­¤é¡¹ã€‚"
      default: "æœ‰äººç§»åŠ¨"
      selector:
        text: {}

    # ===========================
    # 2. è¾…åŠ©å®ä½“
    # ===========================
    helper_sleep_mode:
      name: "è¾…åŠ©å¼€å…³ï¼šç¡çœ æ¨¡å¼"
      description: "âš ï¸ é€‰é¢„å…ˆåˆ›å»ºå¥½çš„ Input Booleanã€‚"
      selector:
        entity:
          domain: input_boolean

    helper_get_up_mode:
      name: "è¾…åŠ©å¼€å…³ï¼šèµ·åºŠæ¨¡å¼"
      description: "âš ï¸ é€‰é¢„å…ˆåˆ›å»ºå¥½çš„ Input Booleanã€‚"
      selector:
        entity:
          domain: input_boolean

    # ===========================
    # 3. [èµ·å¤œ] åºŠå¤´ç¯è®¾ç½®
    # ===========================
    bedside_lights:
      name: "[åºŠå¤´] ç¯å…‰å®ä½“"
      description: "èµ·å¤œæ—¶é¦–å…ˆç‚¹äº®çš„ç¯å…‰"
      selector:
        target:
          entity:
            domain: light
    bedside_brightness:
      name: "[åºŠå¤´] äº®åº¦ (%)"
      default: 2
      selector:
        number: { min: 1, max: 100, unit_of_measurement: "%" }
    bedside_kelvin:
      name: "[åºŠå¤´] è‰²æ¸© (K)"
      default: 3000
      selector:
        number: { min: 2000, max: 6500, unit_of_measurement: "K" }

    # ===========================
    # 4. å…¶ä»–è·¯å¾„è®¾ç½®
    # ===========================
    path_passage_sensor:
      name: "[é€šé“/å®¢å…] è§¦å‘ä¼ æ„Ÿå™¨"
      default: []
      selector:
        entity:
          domain: binary_sensor
          multiple: true
    path_passage_lights:
      name: "[é€šé“/å®¢å…] ç¯å…‰å®ä½“"
      default: []
      selector:
        target:
          entity:
            domain: light
    path_passage_brightness:
      name: "[é€šé“/å®¢å…] äº®åº¦ (%)"
      default: 3
      selector:
        number: { min: 1, max: 100, unit_of_measurement: "%" }
    path_passage_kelvin:
      name: "[é€šé“/å®¢å…] è‰²æ¸© (K)"
      default: 3000
      selector:
        number: { min: 2000, max: 6500, unit_of_measurement: "K" }

    path_a_sensor:
      name: "[ç»ˆç‚¹ A] è§¦å‘ä¼ æ„Ÿå™¨"
      default: []
      selector:
        entity:
          domain: binary_sensor
          multiple: true
    path_a_lights:
      name: "[ç»ˆç‚¹ A] ç¯å…‰å®ä½“"
      default: []
      selector:
        target:
          entity:
            domain: light
    path_a_brightness:
      name: "[ç»ˆç‚¹ A] äº®åº¦ (%)"
      default: 3
      selector:
        number: { min: 1, max: 100, unit_of_measurement: "%" }
    path_a_kelvin:
      name: "[ç»ˆç‚¹ A] è‰²æ¸© (K)"
      default: 3000
      selector:
        number: { min: 2000, max: 6500, unit_of_measurement: "K" }

    path_b_sensor:
      name: "[ç»ˆç‚¹ B] è§¦å‘ä¼ æ„Ÿå™¨"
      default: []
      selector:
        entity:
          domain: binary_sensor
          multiple: true
    path_b_lights:
      name: "[ç»ˆç‚¹ B] ç¯å…‰å®ä½“"
      default: []
      selector:
        target:
          entity:
            domain: light
    path_b_brightness:
      name: "[ç»ˆç‚¹ B] äº®åº¦ (%)"
      default: 3
      selector:
        number: { min: 1, max: 100, unit_of_measurement: "%" }
    path_b_kelvin:
      name: "[ç»ˆç‚¹ B] è‰²æ¸© (K)"
      default: 3000
      selector:
        number: { min: 2000, max: 6500, unit_of_measurement: "K" }

    # ===========================
    # 5. å›åºŠè®¾ç½®
    # ===========================
    lights_to_turn_off:
      name: "[å›åºŠ] ç»Ÿä¸€å…³é—­çš„ç¯ç»„"
      description: "å»ºè®®åŒ…å«æ‰€æœ‰è·¯å¾„ç¯å…‰ï¼Œå›åºŠæ—¶å¼ºåˆ¶å…¨å…³ã€‚"
      selector:
        target:
          entity:
            domain: light

    sleep_start_time:
      name: è‡ªåŠ¨å…¥ç¡/èµ·å¤œå¼€å§‹æ—¶é—´
      default: "21:00:00"
      selector:
        time: {}
    sleep_end_time:
      name: è‡ªåŠ¨å…¥ç¡/èµ·å¤œç»“æŸæ—¶é—´
      default: "07:00:00"
      selector:
        time: {}
    cooldown_seconds:
      name: "å›åºŠå†·å´æ—¶é—´ (ç§’)"
      description: "å›åºŠåé˜²æ­¢è¯¯è§¦åºŠè¾¹/åœ°è„šä¼ æ„Ÿå™¨çš„å†·å´æ—¶é—´ã€‚"
      default: 30
      selector:
        number:
          min: 0
          max: 600
          unit_of_measurement: seconds

mode: queued
max: 10

variables:
  motion_keyword: !input motion_event_keyword
  sleep_mode_entity: !input helper_sleep_mode
  cooldown_sec: !input cooldown_seconds

trigger:
  # 1. å‹åŠ›ä¼ æ„Ÿå™¨ï¼šæœ‰äºº
  - platform: state
    entity_id: !input pressure_sensor
    from: "off"
    to: "on"
    id: "pressure_on"
  
  # 2. å§å®¤ç¯å…‰ç»„ï¼šå…³é—­ (å‡†å¤‡ç¡è§‰/æ¢å¤ç¡çœ )
  - platform: state
    entity_id: !input bedroom_status_light
    from: "on"
    to: "off"
    id: "lights_group_off"

  # 3. å§å®¤ç¯å…‰ç»„ï¼šå¼€å¯ (æ‰‹åŠ¨å”¤é†’æ£€æµ‹) [å…³é”®]
  - platform: state
    entity_id: !input bedroom_status_light
    from: "off"
    to: "on"
    id: "lights_group_on"

  # 4. å‹åŠ›ä¼ æ„Ÿå™¨ï¼šæ— äºº
  - platform: state
    entity_id: !input pressure_sensor
    from: "on"
    to: "off"
    id: "pressure_off"

  # 5. åºŠè¾¹/åœ°è„šçº¢å¤–
  - platform: state
    entity_id: !input motion_sensor_bedside
    id: "motion_bedside"

  # 6. å„è·¯å¾„ä¼ æ„Ÿå™¨
  - platform: state
    entity_id: !input path_passage_sensor
    from: "off"
    to: "on"
    id: "motion_passage"
  - platform: state
    entity_id: !input path_a_sensor
    from: "off"
    to: "on"
    id: "motion_path_a"
  - platform: state
    entity_id: !input path_b_sensor
    from: "off"
    to: "on"
    id: "motion_path_b"

action:
  - choose:
      # ===================================================
      # åœºæ™¯ 1: é¦–æ¬¡å…¥ç¡ / å…³ç¯æ¢å¤ç¡çœ 
      # ===================================================
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: "pressure_on"
              - condition: trigger
                id: "lights_group_off" # ç¯ç»„å…¨å…³
          # ğŸ”´ æ—¶é—´é™åˆ¶
          - condition: time
            after: !input sleep_start_time
            before: !input sleep_end_time
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "off"
          - condition: state
            entity_id: !input helper_sleep_mode
            state: "off"
          # å¿…é¡»äººåœ¨åºŠä¸Š
          - condition: state
            entity_id: !input pressure_sensor
            state: "on"
          # å¿…é¡»å§å®¤æ‰€æœ‰ç¯éƒ½å…³äº†
          - condition: state
            entity_id: !input bedroom_status_light
            state: "off"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: !input helper_sleep_mode
          - service: input_boolean.turn_off
            target:
              entity_id: !input helper_get_up_mode            

      # ===================================================
      # åœºæ™¯ 2: å›åºŠ (èµ·å¤œç»“æŸ)
      # ===================================================
      - conditions:
          - condition: trigger
            id: "pressure_on"
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "on"
        sequence:
          - service: light.turn_off
            target: !input lights_to_turn_off
          - service: light.turn_off
            target: !input bedside_lights
          - service: input_boolean.turn_off
            target:
              entity_id: !input helper_get_up_mode
          - service: input_boolean.turn_on
            target:
              entity_id: !input helper_sleep_mode

     # ===================================================
      # åœºæ™¯ 3: èµ·å¤œä¸‹åºŠ (åºŠè¾¹è§¦å‘)
      # ===================================================
      - conditions:
          - condition: trigger
            id: "motion_bedside"
          # ğŸ”´ æ—¶é—´é™åˆ¶
          - condition: time
            after: !input sleep_start_time
            before: !input sleep_end_time
          - condition: state
            entity_id: !input helper_sleep_mode
            state: "on"
          # å†·å´åˆ¤æ–­
          - condition: template
            value_template: >
              {% set trigger_entity = trigger.entity_id %}
              {% set domain = trigger_entity.split('.')[0] %}
              {% if domain == 'binary_sensor' %}
                {{ trigger.to_state.state == 'on' }}
              {% elif domain == 'event' %}
                {{ trigger.to_state.attributes.event_type is defined 
                   and trigger.to_state.attributes.event_type == motion_keyword }}
              {% else %}
                false
              {% endif %}
          - condition: template
            value_template: >
              {% if states[sleep_mode_entity] is defined and states[sleep_mode_entity].last_changed %}
                {{ (as_timestamp(now()) - as_timestamp(states[sleep_mode_entity].last_changed)) > (cooldown_sec | int) }}
              {% else %}
                true
              {% endif %}
          # å¿…é¡»å½“å‰ä¸åœ¨èµ·å¤œæ¨¡å¼ä¸­ (é˜²æ­¢é‡å¤è§¦å‘)
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "off"
        sequence:
          # å…ˆå¼€èµ·å¤œæ¨¡å¼æ ‡è®°ï¼Œå†å¼€ç¯
          # è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢ "å§å®¤ç¯ç»„å˜äº®" çš„è§¦å‘å™¨è¯¯åˆ¤ä¸ºäººä¸ºæ“ä½œ
          - service: input_boolean.turn_on
            target:
              entity_id: !input helper_get_up_mode
          - service: input_boolean.turn_off
            target:
              entity_id: !input helper_sleep_mode
          - service: light.turn_on
            target: !input bedside_lights
            data:
              brightness_pct: !input bedside_brightness
              color_temp_kelvin: !input bedside_kelvin

      # ===================================================
      # åœºæ™¯ 4: ç¦»å¼€åºŠé“º
      # ===================================================
      - conditions:
          - condition: trigger
            id: "pressure_off"
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "on"
        sequence: []

      # ===================================================
      # åœºæ™¯ 5~7: è·¯å¾„æ„Ÿåº” (çœç•¥é‡å¤è§£é‡Š)
      # ===================================================
      - conditions:
          - condition: trigger
            id: "motion_passage"
          - condition: time
            after: !input sleep_start_time
            before: !input sleep_end_time
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "on"
        sequence:
          - service: light.turn_on
            target: !input path_passage_lights
            data:
              brightness_pct: !input path_passage_brightness
              color_temp_kelvin: !input path_passage_kelvin

      - conditions:
          - condition: trigger
            id: "motion_path_a"
          - condition: time
            after: !input sleep_start_time
            before: !input sleep_end_time
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "on"
        sequence:
          - service: light.turn_on
            target: !input path_a_lights
            data:
              brightness_pct: !input path_a_brightness
              color_temp_kelvin: !input path_a_kelvin

      - conditions:
          - condition: trigger
            id: "motion_path_b"
          - condition: time
            after: !input sleep_start_time
            before: !input sleep_end_time
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "on"
        sequence:
          - service: light.turn_on
            target: !input path_b_lights
            data:
              brightness_pct: !input path_b_brightness
              color_temp_kelvin: !input path_b_kelvin

      # ===================================================
      # åœºæ™¯ 8: æ‰‹åŠ¨å”¤é†’æ£€æµ‹ (ç¯ç»„å˜äº®)
      # ===================================================
      - conditions:
          - condition: trigger
            id: "lights_group_on"
          # å…³é”®æ¡ä»¶ï¼šåªæœ‰å½“ç³»ç»Ÿåˆ¤å®š "ç°åœ¨ä¸æ˜¯æˆ‘åœ¨å¸®ä½ èµ·å¤œ" æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯æ‰‹åŠ¨
          - condition: state
            entity_id: !input helper_get_up_mode
            state: "off"
          # ä¸”ä¹‹å‰å¤„äºç¡çœ çŠ¶æ€
          - condition: state
            entity_id: !input helper_sleep_mode
            state: "on"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: !input helper_sleep_mode
          # ä¸éœ€è¦æ“ä½œ get_up_modeï¼Œå› ä¸ºå®ƒå·²ç»æ˜¯ off