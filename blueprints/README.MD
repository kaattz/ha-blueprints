# Home Assistant 智能蓝图集

本仓库包含四个精心设计的 Home Assistant 蓝图，用于实现智能家居自动化。这些蓝图涵盖了窗帘控制、夜灯模式和起夜模式等常见场景。

## 📋 蓝图列表

### 1. 智能阳光窗帘控制
**文件**: [`智能阳光窗帘控制.yaml`](blueprints/智能阳光窗帘控制.yaml)

根据阳光照射和人体感应智能控制窗帘的自动化方案。

#### 核心功能
- **阳光直射保护**: 当阳光直射窗户时自动关闭窗帘
- **智能开启**: 阳光消失后根据人体感应决定是否开启
- **天气感知**: 结合天气数据避免雨天误触发
- **方位角计算**: 精确计算太阳位置，只在必要时触发

#### 配置参数
- **目标窗帘**: 需要控制的窗帘实体
- **人体存在传感器** (可选): 用于卧室场景，确保无人时才开启
- **光照传感器**: 检测环境光照强度 (Lux)
- **天气实体**: 获取当前天气状态
- **窗户方位角**: 窗户朝向 (0=北, 90=东, 180=南, 270=西)
- **方位角范围**: 阳光直射的有效角度范围
- **最小太阳高度角**: 太阳低于此角度时不触发
- **光照触发阈值**: 触发关闭的最低 Lux 值
- **无阳光等待时间**: 阳光消失后等待多久才开启
- **无人等待时间**: 确认无人后等待多久才开启

#### 使用场景
- **客厅**: 不配置人体传感器，阳光消失立即开启
- **卧室**: 配置人体传感器，确保无人且超时后才开启

---

### 2. 无线窗帘电动窗单键循环控制
**文件**: [`无线窗帘电动窗单键循环控制.yaml`](blueprints/无线窗帘电动窗单键循环控制.yaml)

实现单键控制窗帘循环动作 (开 → 停 → 关 → 停)，支持多种触发设备。

#### 核心功能
- **智能循环**: 按键触发时自动判断是停止还是反向动作
- **状态追踪**: 自动监听系统指令，计算剩余时间
- **多设备支持**: 
  - KNX/普通面板 (Device触发器)
  - 领普/米家遥控 (Event实体)
  - 宜家/Z2M遥控 (Device触发器)

#### 配置参数
- **目标窗帘**: 需要控制的窗帘实体
- **结束时间辅助实体**: 记录窗帘运动结束时间的 input_datetime
- **上次动作记录**: 记录上次动作方向的 input_select
- **全程运行时间**: 窗帘从完全关闭到完全打开所需时间 (秒)
- **KNX Group Address**: KNX 设备组地址列表
- **领普/米家事件实体**: Event 实体 ID
- **领普通按键编号**: 1=左，2=上，3=右，4=下
- **通用单键事件**: 通用 Event 实体
- **Z2M/IKEA 遥控器设备**: Z2M 设备 ID
- **Z2M 动作名**: 如 toggle, brightness_up_click, arrow_left_click

#### 工作原理
1. 监听多种触发源 (KNX、Event、Device)
2. 根据当前状态判断是停止还是反向动作
3. 自动追踪窗帘运动状态，确保准确控制

---

### 3. 卧室进入夜灯模式
**文件**: [`卧室进入夜灯模式.yaml`](blueprints/卧室进入夜灯模式.yaml)

当卧室有人且处于睡眠模式时，检测到从门外进入则自动开启夜灯。

#### 核心功能
- **智能进入检测**: 通过门磁和红外传感器判断进入动作
- **睡眠模式联动**: 只在睡眠模式下触发
- **夜灯优化**: 自动设置低亮度和暖色温

#### 所需设备
- **卧室门磁**: 安装于卧室门
- **人体存在传感器**: 安装于卧室内
- **门口/走廊红外传感器**: 安装于卧室门外
- **睡眠模式开关**: input_boolean 虚拟开关

#### 配置参数
- **卧室门磁传感器**: 检测门开关状态
- **卧室人体存在传感器**: 确认卧室内有人
- **门口/走廊红外传感器**: 判断从外向内的进入动作
- **睡眠模式开关**: 支持多选，任意一个为 ON 即生效
- **目标灯光**: 需要开启夜灯模式的灯具
- **进入判定时间窗口**: 门口红外触发后多少秒内开门算有效进入 (默认 15秒)
- **夜灯亮度**: 默认 2%
- **灯光色温**: 默认 3000K
- **渐变时间**: 默认 1秒

#### 逻辑流程
1. 卧室门被打开触发
2. 检查卧室内有人且睡眠模式开启
3. 确认门外红外最近被触发 (证明是刚走过来)
4. 开启夜灯并应用预设参数

---

### 4. 智能起夜模式
**文件**: [`智能起夜模式.yaml`](blueprints/智能起夜模式.yaml)

完整的起夜自动化解决方案，支持多路径灯光控制和智能状态管理。

#### 核心功能
- **入睡检测**: 自动检测上床动作并开启睡眠模式
- **起夜下床检测**: 床边传感器触发起夜模式
- **路径灯光控制**: 支持多路径灯光自动开启
- **回床检测**: 自动关闭所有起夜灯光
- **手动唤醒检测**: 识别手动开灯操作

#### 配置参数

##### 核心传感器
- **床铺压力传感器**: Binary Sensor (on=在床上, off=离床)
- **卧室灯光状态检测**: 包含卧室所有灯的组或传感器
- **床边/地脚传感器**: 检测下床动作 (Binary 或 Event)
- **Event 触发关键词**: Event 实体需要填写

##### 辅助实体
- **辅助开关：睡眠模式**: input_boolean
- **辅助开关：起床模式**: input_boolean

##### 床头灯设置
- **[床头] 灯光实体**: 起夜时首先点亮的灯光
- **[床头] 亮度**: 默认 2%
- **[床头] 色温**: 默认 3000K

##### 其他路径设置
支持配置三条路径 (通道/客厅、终点 A、终点 B)，每条路径可设置：
- 触发传感器
- 灯光实体
- 亮度和色温

##### 回床设置
- **统一关闭的灯组**: 建议包含所有路径灯光
- **自动入睡/起夜时间**: 默认 21:00-07:00
- **回床冷却时间**: 防止误触的冷却时间 (默认 30秒)

#### 场景说明
1. **首次入睡/关灯恢复睡眠**: 压力传感器检测到人在床上且卧室灯关闭
2. **回床 (起夜结束)**: 压力传感器检测到人在床上且处于起夜模式
3. **起夜下床**: 床边传感器触发，开启床头灯
4. **离开床铺**: 压力传感器检测到离床
5. **路径感应**: 各路径传感器触发，开启对应路径灯光
6. **手动唤醒检测**: 识别非自动化的手动开灯操作

---

## 🚀 快速开始

### 前提条件
- Home Assistant 已安装并运行
- 已配置相关设备实体 (传感器、灯光、窗帘等)
- 已安装 Blueprint 功能 (Home Assistant 默认包含)

### 安装步骤
1. 将蓝图文件复制到 Home Assistant 的 `blueprints/automation/` 目录
2. 重启 Home Assistant 或重新加载蓝图
3. 在 Home Assistant 界面中进入 **配置 → 自动化 → 蓝图**
4. 点击 **创建自动化** 并选择相应的蓝图
5. 根据配置说明填写所需参数
6. 保存并启用自动化

### 调试建议
- 使用 Home Assistant 的 **日志** 功能查看自动化执行情况
- 在开发阶段可添加 **通知** 动作来确认触发
- 检查实体状态是否正确更新
- 验证时间窗口和传感器灵敏度设置

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这些蓝图！

---

## 📄 许可证

本项目采用 MIT 许可证 - 查看 LICENSE 文件了解详情